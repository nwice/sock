<!DOCTYPE html>
<html>
<head>
    <title>Snowball Network Analytics</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css" rel="stylesheet">

    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script src="https://unpkg.com/@metamask/detect-provider/dist/detect-provider.min.js"></script>
    <script src="https://unpkg.com/web3/dist/web3.min.js"></script>
    <style>
        * {
            font-size: x-large
        }

        :root {
            --mdc-theme-on-primary: #33A9FF;
            --mdc-theme-primary: #1B1F32;     
        }

        .mdc-top-app-bar {
            color:white;
        }

        .notused {
            --mdc-theme-primary-bg: #30364e;            
            --mdc-theme-secondary: red;
            --mdc-theme-secondary-bg: yellow;
            --mdc-theme-on-secondary: gold;

            --mdc-theme-surface: purple;
            --mdc-theme-on-surface: brown; 
            --mdc-theme-background: #1B1F32;
        }

        body > section:first-of-type {
            padding-top: 100px;
        }

        body,
        html {
            margin: 0;
        }
        #choice {
            display: flex;
            flex-direction: row;
            align-items: center;
        }
    </style>
</head>
<template id="choice_section">
    <section id="choice">
        <div>
            Look up
            <button onClick="document.dispatchEvent(new CustomEvent('wallet')); this.disabled = true;"
                class="mdc-button mdc-button--touch">
                <span class="mdc-button__ripple"></span>
                <span class="mdc-button__label">Wallet</span>
                <span class="mdc-button__touch"></span>
            </button>
        </div>
        <div>
            <div>
                Account Lookup
                <label class="mdc-text-field mdc-text-field--outlined">
                    <span class="mdc-notched-outline">
                        <span class="mdc-notched-outline__leading"></span>
                        <span class="mdc-notched-outline__notch">
                            <span class=" " id="my-label-id">Account</span>
                        </span>
                        <span class="mdc-notched-outline__trailing"></span>
                    </span>
                    <input type="text" class="mdc-text-field__input" aria-labelledby="my-label-id" id="account_input"
                        onChange="document.dispatchEvent(new CustomEvent('account', { detail: this.value })); this.value = ''; ">
                </label>
                ex: <button 
                    onClick="let i = document.querySelector('#account_input'); i.value = '0x52E49872153fb72F96a0E4a04356d06d5b4AaCd8'; setTimeout( () => { i.onchange() }, 1000)"
                    class="mdc-button mdc-button--touch">
                    <span class="mdc-button__ripple"></span>
                    <span class="mdc-button__label">0x52E49872153fb72F96a0E4a04356d06d5b4AaCd8</span>
                    <span class="mdc-button__touch"></span>
                </button>                                
            </div>
        </div>
    </section>
</template>

<template id="lookup_div">
    <div class="lookup">
        Account: <span class="account"></span>
        <div class="reponse">

        </div>
    </div>
</template>

<template id="detail_div">
    <div class="lookup">
    </div>
</template>

<script type="module">

    let web3 = new Web3('wss://beta.scewpt.com:443/ext/bc/C/ws');

    var tokenABI = [{ 
        "constant": true, 
        "inputs": [{ "name": "_owner", "type": "address" }], 
        "name": "balanceOf", 
        "outputs": [{ "name": "balance", "type": "uint256" }], 
        "payable": false, 
        "type": "function" 
    }];

    var tokenABI2 = [{ 
        "constant": true, 
        "inputs": [], 
        "name": "balanceOf", 
        "outputs": [{ "name": "balance", "type": "uint256" }], 
        "payable": false, 
        "type": "function" 
    }];    

    var tokenABI3 = [{ 
        "constant": true, 
        "inputs": [], 
        "name": "price0CumulativeLast", 
        "outputs": [{ "name": "value", "type": "uint256" }], 
        "payable": false, 
        "type": "function" 
    },{ 
        "constant": true, 
        "inputs": [], 
        "name": "price1CumulativeLast", 
        "outputs": [{ "name": "value", "type": "uint256" }], 
        "payable": false, 
        "type": "function" 
    }];

    document.addEventListener('account', (e) => {
        let qs = 'account-' + e.detail
        if (document.querySelector('#' + qs) == null) {
            let lookup = document.querySelector('#lookup_div').content.cloneNode(true)
            lookup.querySelector('.account').innerHTML = e.detail
            lookup.firstElementChild.setAttribute('id', qs);
            document.querySelector('#app').appendChild(lookup);
            contractInstance.methods.tokensOfOwner(e.detail).call().then(r => {
                document.querySelector('#account-' + e.detail + ' .reponse').innerHTML = 'Avalanche Punks By Id: ' + r
            })
            console.log('contract options:', contractInstance.options);
        }
    })

    document.addEventListener('detail', (e) => {
        let div = document.querySelector('#detail_div').content.cloneNode(true)
        div.firstElementChild.innerHTML = e.detail
        document.querySelector('#app').appendChild(div);
    });

    document.addEventListener('wallet', (e) => {

        detectEthereumProvider().then((provider) => {
            console.log('provider - we make a promise all on connect - that the provider is good - then lastly the chainid')
            Promise.all([
                Promise.resolve(provider?.isConnected()),
                Promise.resolve(window?.ethereum && provider === window?.ethereum),
                provider?.request({
                    method: 'eth_chainId'
                }).then((chainId) => {
                    if (chainId === '0xa86a') {

                        provider.on('chainChanged', (chainId) => {
                            window.location.reload();
                        });

                        ['connect', 'disconnect', 'accountsChanged', 'message'].forEach(k => {
                            provider.on(k, (a) => {
                                console.log(`${k}:`, a);
                            })
                        });

                        return provider.request({
                            method: 'eth_accounts'
                        }).then((accounts) => {
                            if (accounts[0]) {
                                document.dispatchEvent(new CustomEvent('account', { detail: accounts[0] }))
                                return true;
                            } else {
                                return provider.request({
                                    method: 'eth_requestAccounts'
                                }).then(requested_accounts => {
                                    if (requested_accounts[0]) {
                                        document.dispatchEvent(new CustomEvent('account', { detail: requested_accounts[0] }))
                                        return true;
                                    } else {
                                        document.dispatchEvent(new CustomEvent('detail', { detail: 'no accounts:' + r }))
                                        return false;
                                    }
                                })
                            }
                        }).catch((err) => {
                            document.dispatchEvent(new CustomEvent('detail', { detail: 'exception:' + err.message }))
                            return false;
                        });
                    } else {
                        document.dispatchEvent(new CustomEvent('detail', { detail: 'wrong chain:' + err }))
                        return false
                    }
                })]).then(pa => {
                    if (!pa.every(Boolean)) {
                        console.log('error?:', pa)
                    }
                })
        })
    })

    document.body.appendChild(
        document.querySelector('#choice_section').content.cloneNode(true)
    );

    //{
    //        contract: '0xdE1A11C331a0E45B9BA8FeE04D4B51A745f1e4A4',
    //        accounts: [{stake:'0xB12531a2d758c7a8BF09f44FC88E646E1BF9D375'}]
    //    },            


    const ic = [

        // account: 0x74db28797957a52a28963f424daf2b10226ba04c no staked usdt
        // account: 0x6a803904b9ea0fc982fbb077c7243c244ae05a2d no staked png 

        // contract: 0x1acf1583bebdca21c8025e172d8e8f2817343d65 account: 0x586554828eE99811A8ef75029351179949762c26 balance of: 136.21722176718325 -- pooled eth
        // contract: 0xa16381eae6285123c323a665d4d99a6bcfaac307 account: 0x953853590b805A0E885A75A3C786D2aFfcEEA3Cf balance of: 6645.987639455652 -- staked eth

        // contract: 0x88f26b81c9cae4ea168e31bc6353f493fda29661 account: 0x14ec55f8B4642111A5aF4f5ddc56B7bE867eB6cC balance of: 32017.91011479183 -- staked sushi        
        // contract: 0xd8b262c0676e13100b33590f10564b46eef652ad account: 0x751089F1bf31B13Fa0F0537ae78108088a2253BF balance of: 2.6750071640149753 -- pooled sushi

        // contract: 0xa1c2c3b6b120cbd4cec7d2371ffd4a931a134a32 account: 0xB12531a2d758c7a8BF09f44FC88E646E1BF9D375 balance of: 578722.466263787 -- ice queen 
        
        // contract: 0xd7538cabbf8605bde1f4901b47b8d42c61de0367 account: 0x621207093D2e65Bf3aC55dD8Bf0351B980A63815 balance of: 3347.9588963076003 -- pooled png
        
        // contract: 0x7d7ecd4d370384b17dfc1b4155a8410e97841b65 account: 0x974Ef0bDA58C81F3094e124f530eF34fe70dc103 balance of: 42627.06011020803 -- staked link
        // contract: 0xbbc7fff833d27264aac8806389e02f717a5506c9 account: 0x00933c16e06b1d15958317C2793BC54394Ae356C balance of: 135.6367279482053 -- pooled link        
    ]

    const pairs = [
        {
            contract: '0x9EE0a4E21bd333a6bb2ab298194320b8DaA26516',
            accounts: [{stake: '0x74db28797957a52a28963f424daf2b10226ba04c'}]
        }         
    ]

    const values = [
        { account: '0x7d7ecd4d370384b17dfc1b4155a8410e97841b65', contract: '0xbbC7fFF833D27264AaC8806389E02F717A5506c9' },
        { account: '0x974Ef0bDA58C81F3094e124f530eF34fe70dc103', contract: '0x7d7ecd4d370384b17dfc1b4155a8410e97841b65' },
    ]


    const ICEQUEEN_ABI = [{ "type": "constructor", "stateMutability": "nonpayable", "inputs": [{ "type": "address", "name": "_snowball", "internalType": "contract Snowball" }, { "type": "address", "name": "_devfund", "internalType": "address" }, { "type": "address", "name": "_treasury", "internalType": "address" }, { "type": "uint256", "name": "_snowballPerBlock", "internalType": "uint256" }, { "type": "uint256", "name": "_startBlock", "internalType": "uint256" }, { "type": "uint256", "name": "_bonusEndBlock", "internalType": "uint256" }] }, { "type": "event", "name": "Deposit", "inputs": [{ "type": "address", "name": "user", "internalType": "address", "indexed": true }, { "type": "uint256", "name": "pid", "internalType": "uint256", "indexed": true }, { "type": "uint256", "name": "amount", "internalType": "uint256", "indexed": false }], "anonymous": false }, { "type": "event", "name": "EmergencyWithdraw", "inputs": [{ "type": "address", "name": "user", "internalType": "address", "indexed": true }, { "type": "uint256", "name": "pid", "internalType": "uint256", "indexed": true }, { "type": "uint256", "name": "amount", "internalType": "uint256", "indexed": false }], "anonymous": false }, { "type": "event", "name": "OwnershipTransferred", "inputs": [{ "type": "address", "name": "previousOwner", "internalType": "address", "indexed": true }, { "type": "address", "name": "newOwner", "internalType": "address", "indexed": true }], "anonymous": false }, { "type": "event", "name": "Recovered", "inputs": [{ "type": "address", "name": "token", "internalType": "address", "indexed": false }, { "type": "uint256", "name": "amount", "internalType": "uint256", "indexed": false }], "anonymous": false }, { "type": "event", "name": "Withdraw", "inputs": [{ "type": "address", "name": "user", "internalType": "address", "indexed": true }, { "type": "uint256", "name": "pid", "internalType": "uint256", "indexed": true }, { "type": "uint256", "name": "amount", "internalType": "uint256", "indexed": false }], "anonymous": false }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "BONUS_MULTIPLIER", "inputs": [] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "add", "inputs": [{ "type": "uint256", "name": "_allocPoint", "internalType": "uint256" }, { "type": "address", "name": "_lpToken", "internalType": "contract IERC20" }, { "type": "bool", "name": "_withUpdate", "internalType": "bool" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "bonusEndBlock", "inputs": [] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "deposit", "inputs": [{ "type": "uint256", "name": "_pid", "internalType": "uint256" }, { "type": "uint256", "name": "_amount", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "devFundDivRate", "inputs": [] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "address", "name": "", "internalType": "address" }], "name": "devfund", "inputs": [] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "emergencyWithdraw", "inputs": [{ "type": "uint256", "name": "_pid", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "getMultiplier", "inputs": [{ "type": "uint256", "name": "_from", "internalType": "uint256" }, { "type": "uint256", "name": "_to", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "massUpdatePools", "inputs": [] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "address", "name": "", "internalType": "address" }], "name": "owner", "inputs": [] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "pendingSnowball", "inputs": [{ "type": "uint256", "name": "_pid", "internalType": "uint256" }, { "type": "address", "name": "_user", "internalType": "address" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "address", "name": "lpToken", "internalType": "contract IERC20" }, { "type": "uint256", "name": "allocPoint", "internalType": "uint256" }, { "type": "uint256", "name": "lastRewardBlock", "internalType": "uint256" }, { "type": "uint256", "name": "accSnowballPerShare", "internalType": "uint256" }], "name": "poolInfo", "inputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "poolLength", "inputs": [] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "renounceOwnership", "inputs": [] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "set", "inputs": [{ "type": "uint256", "name": "_pid", "internalType": "uint256" }, { "type": "uint256", "name": "_allocPoint", "internalType": "uint256" }, { "type": "bool", "name": "_withUpdate", "internalType": "bool" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "setBonusEndBlock", "inputs": [{ "type": "uint256", "name": "_bonusEndBlock", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "setDevFundDivRate", "inputs": [{ "type": "uint256", "name": "_devFundDivRate", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "setSnowballPerBlock", "inputs": [{ "type": "uint256", "name": "_snowballPerBlock", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "setTreasuryDivRate", "inputs": [{ "type": "uint256", "name": "_treasuryDivRate", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "address", "name": "", "internalType": "contract Snowball" }], "name": "snowball", "inputs": [] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "snowballPerBlock", "inputs": [] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "startBlock", "inputs": [] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "totalAllocPoint", "inputs": [] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "transferOwnership", "inputs": [{ "type": "address", "name": "newOwner", "internalType": "address" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "address", "name": "", "internalType": "address" }], "name": "treasury", "inputs": [] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }], "name": "treasuryDivRate", "inputs": [] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "updateDevfund", "inputs": [{ "type": "address", "name": "_devfund", "internalType": "address" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "updatePool", "inputs": [{ "type": "uint256", "name": "_pid", "internalType": "uint256" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "updateTreasury", "inputs": [{ "type": "address", "name": "_treasury", "internalType": "address" }] }, { "type": "function", "stateMutability": "view", "outputs": [{ "type": "uint256", "name": "amount", "internalType": "uint256" }, { "type": "uint256", "name": "rewardDebt", "internalType": "uint256" }], "name": "userInfo", "inputs": [{ "type": "uint256", "name": "", "internalType": "uint256" }, { "type": "address", "name": "", "internalType": "address" }] }, { "type": "function", "stateMutability": "nonpayable", "outputs": [], "name": "withdraw", "inputs": [{ "type": "uint256", "name": "_pid", "internalType": "uint256" }, { "type": "uint256", "name": "_amount", "internalType": "uint256" }] }]


    console.log('options:', new web3.eth.Contract(tokenABI, values[0].contract).options);

    new web3.eth.Contract(tokenABI, values[0].contract).methods.balanceOf('0xb3fe5374f67d7a22886a0ee082b2e2f9d2651651').call().then(bo => {
        console.log('balance:', bo);
    }).catch( (err) => {
        console.log('err:', err)
    })

    Promise.all(values.map(v => {        
        return new web3.eth.Contract(tokenABI, v.contract).methods.balanceOf(v.account).call().then(bo => {
            v.balanceOf = bo / 1e18
            console.log('contract:', v.contract, 'account:', v.account, 'balance of:', bo / 1e18);
            return v
        }).catch( (err) => {
            console.log('contract:', v.contract, 'account:', v.account, 'error:', err)
        })        
    })).then(res => {
        console.log('result:', res);

        //new web3.eth.Contract(tokenABI, values[0].contract).methods.balanceOf('0xb3fe5374f67d7a22886a0ee082b2e2f9d2651651').call().then(bo => {                
        //    console.log('price0:', bo )
        //}).catch( (err) => {
        //    console.log('price 0 error:', err)
        //})

        //new web3.eth.Contract(tokenABI, values[0].contract).methods.balanceOf('0xb31f66aa3c1e785363f0875a1b74e27b85fd66c7').call().then(bo => {                
        //    console.log('price1:', bo )
        //}).catch( (err) => {
        //    console.log('price 1 error:', err)
        //})            

    })



    const edtTexts = [].map.call(document.querySelectorAll('.mdc-text-field'), (el) => {
        return new mdc.textField.MDCTextField(el);
    });

    let diaglog = document.querySelector('.mdc-dialog .mdc-list')

    const list = new mdc.list.MDCList(diaglog);

    dialog.listen('MDCDialog:opened', function () {
        contentElement.setAttribute('aria-hidden', 'true');
    });

    dialog.listen('MDCDialog:closing', function () {
        contentElement.removeAttribute('aria-hidden');
    });
</script>

<body id="app">
    <header class="mdc-top-app-bar">
        <div class="mdc-top-app-bar__row">
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">                
                <img src="/assets/images/logo.png" width="50" height="50">
                <span class="mdc-top-app-bar__title">Snowball Network Analytics</span>
            </section>
            <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end" role="toolbar">
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button"
                    aria-label="Favorite">favorite</button>
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button"
                    aria-label="Search">search</button>
                <button class="material-icons mdc-top-app-bar__action-item mdc-icon-button"
                    aria-label="Options">more_vert</button>
            </section>
        </div>
    </header>
    <div class="mdc-dialog">
        <div class="mdc-dialog__container">
            <div class="mdc-dialog__surface" role="alertdialog" aria-modal="true" aria-labelledby="my-dialog-title"
                aria-describedby="my-dialog-content">
                <div class="mdc-dialog__content" id="my-dialog-content">
                    Discard draft?
                </div>
                <div class="mdc-dialog__actions">
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="cancel">
                        <div class="mdc-button__ripple"></div>
                        <span class="mdc-button__label">Cancel</span>
                    </button>
                    <button type="button" class="mdc-button mdc-dialog__button" data-mdc-dialog-action="discard">
                        <div class="mdc-button__ripple"></div>
                        <span class="mdc-button__label">Discard</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="mdc-dialog__scrim"></div>
    </div>
    <div class="mdc-snackbar">
        <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
            <div class="mdc-snackbar__label" aria-atomic="false">
                Can't send photo. Retry in 5 seconds.
            </div>
            <div class="mdc-snackbar__actions" aria-atomic="true">
                <button type="button" class="mdc-button mdc-snackbar__action">
                    <div class="mdc-button__ripple"></div>
                    <span class="mdc-button__label">Retry</span>
                </button>
            </div>
        </div>
    </div>    
</body>
</html>